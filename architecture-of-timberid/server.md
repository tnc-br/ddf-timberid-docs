# ðŸ–¥ Server

### Database design&#x20;

The database is a [Cloud Firestore](https://firebase.google.com/docs/firestore) Database. Cloud Firestore is a flexible, scalable NoSQL cloud database. It leverages Firebase Authentication to eliminate a middle tier and allow secure direct read/writes from the front end.

{% hint style="info" %}
The <mark style="color:green;">**development**</mark> database can be found [here](https://console.cloud.google.com/firestore/databases/-default-/data/query;collection=%2Fnew\_users?authuser=0\&project=river-sky-386919). \
The <mark style="color:red;">**production**</mark> database can be found [here](https://console.cloud.google.com/firestore/databases/-default-/data/query;collection=%2Fnew\_users?authuser=0\&project=timberid-prd).
{% endhint %}

The schema of the database is below.

<table><thead><tr><th width="199">Document </th><th width="181">Field</th><th>Data</th></tr></thead><tbody><tr><td>trusted_samples</td><td></td><td>All data for a particular trusted sample including metadata like site of collection, and user who entered the sample, as well as the results.<br>Each document is a single sample that may contain multiple measurements.</td></tr><tr><td></td><td>code</td><td>The unique id associated with the sample</td></tr><tr><td></td><td>created_by</td><td>The id of the user who created the entry</td></tr><tr><td></td><td>created_by_name</td><td>The user name of the creator</td></tr><tr><td></td><td>create_on</td><td>The date which this sample was entered into the database</td></tr><tr><td></td><td>d13C_cel</td><td>The delta C-13 isotope ratio as measured on cellulose by a mass spectrometer.</td></tr><tr><td></td><td>d13C_wood</td><td>The delta C-13 isotope ratio as measured on wood by a mass spectrometer.</td></tr><tr><td></td><td>d15N_wood</td><td>The delta N-15 isotope ratio as measured on wood by a mass spectrometer.</td></tr><tr><td></td><td>d18O_wood</td><td>The delta O-18 isotope ratio as measured on wood by a mass spectrometer.</td></tr><tr><td></td><td>d18O_cel</td><td>The delta O-18 isotope ratio as measured on cellulose by a mass spectrometer.</td></tr><tr><td></td><td>last_updated</td><td>The datetime when this sample entry was last updated</td></tr><tr><td></td><td>lat</td><td>For trusted samples, it is the known latitude where the original tree had been felled for collection.</td></tr><tr><td></td><td>lon</td><td>For trusted samples, it is the known longitude where the original tree had been felled for collection.</td></tr><tr><td></td><td>municipality</td><td>The Brazilian municipality closest to the lat/lon given</td></tr><tr><td></td><td>org</td><td>The organization id that owns this data</td></tr><tr><td></td><td>org_name</td><td>The organization name</td></tr><tr><td></td><td>points</td><td>Points is a collection of arbitrary fields as seen by an import. Every column during an import is loaded into the database into this document collection.<br>Each row in this collection represents one timber subsample taken at a particular point in a larger timber sample.</td></tr><tr><td></td><td>points[0..999].XXX</td><td>Each Field is a comprehensive list of values associated with a particular measured point on the timber sample.<br>It will typically include the distance from center (with 0% being the center and 100% being the bark)</td></tr><tr><td></td><td>site</td><td>The name of the site where collection took place</td></tr><tr><td></td><td>state</td><td>The name of the state where collection took place.</td></tr><tr><td></td><td>status</td><td>Either "in_progress" or "complete" depending on whether the lab has finished processing the sample and values have been fully entered.</td></tr><tr><td></td><td>trusted</td><td>One of "trusted", "untrusted" or "unknown"<br><br>Trusted samples are those where the original tree was sampled by a known reliable entity, such as USP, TNC or Imaflora. In this case, lat/lon should be filled in and represents the location where the entity took the sample from a live tree.<br><br>Untrusted samples are those that may be seized by enforcement.  In this case, lat/lon may be filled in, but represents a statement by the entity that cut the timber of the original tree location.<br><br>Unknown is a subcategory of Untrusted and represents those pieces of timber where the lat/lon was not recorded or not claimed.</td></tr><tr><td></td><td>visibility</td><td>All current values should be private. In a future version, samples may be made "public" which allows users from other organizations to view them.</td></tr><tr><td>untrusted_samples</td><td></td><td>Identical to trusted_samples, but holds all samples where trusted = "untrusted"</td></tr><tr><td>unknown_samples</td><td></td><td>Identical to trusted_samples, but holds all samples where trusted = "unknown"</td></tr><tr><td>new_users</td><td></td><td><p>All data a new user enters when signing up for an account: </p><ul><li>Name</li><li>Email</li><li>Organization to join or name of new organization they are proposing is created </li><li>Date of account creation</li></ul></td></tr><tr><td>organizations</td><td></td><td>Contains a list of documents with keys corresponding to each organization ID. Each document contains the members in the organization and their data (name, email, date joined), the org admins and their data (name, email, date joined), and the org name </td></tr><tr><td>site_admins</td><td></td><td>A list of the site admins.</td></tr></tbody></table>



### Cloud functions

Cloud functions will be used to give members and admins their permissions once they have been approved.&#x20;

User journeys\


| Function Name                               | Trigger                                                                                                                  | Description                                                                                                                                                                                                            |
| ------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Org admin approves new membership           | New member is added to the organzations DB including their information                                                   | <p>When an organization's document is updated, the cloud function determines what was changed. It will find the new user and update their token values: </p><ul><li>Role: member</li><li>Org: &#x3C;org_id> </li></ul> |
|                                             |                                                                                                                          |                                                                                                                                                                                                                        |
| Site admin approves new organization        | New org is added to the organization database with the user who proposed the organization as the only member and admin.  | <p>Cloud function triggered when a new document is created in the Organizations collection. It will update the new adminâ€™s auth tokens:</p><ul><li>Role: admin</li><li>Org: &#x3C;org_id></li></ul>                    |
| Site admin approves new site admin          | New site admin ID is added to the site\_admin collection                                                                 | <p>Cloud function triggered when a new document is added to the site_admin collection. It will update the new site admins auth tokens:</p><ul><li>Role: site_admin</li><li>Org: &#x3C;unchanged></li></ul>             |
| Site admin removes member from organization | Member is removed from member list in the document corresponding to that organization in the organizations collection    | <p>Cloud function triggered with the organization's document is updated. Old members auth tokens are updated:</p><ul><li>Role: &#x3C;></li><li>Org: &#x3C;></li></ul>                                                  |

### Deploying Functions for Testing and Production

The github repository has github actions already configured to generate live previews URLS for all PRs.  You can find out more about how these actions were configured [here](https://firebase.google.com/docs/hosting/github-integration#set-up).

* Merging code into the Main branch will automatically update the development environment: [development.timberid.org](https://development.timberid.org)
* You must manually run a Github action to deploy code from the Main branch to the production url [timberid.org](https://timberid.org)
